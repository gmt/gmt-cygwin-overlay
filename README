This is the gmt cygwin gentoo-prefix overlay.  It will be, I hope, a /temporary/
resting place for various patches that are on their way to various upstream
projects, but which, in the meanwhile, are useful or necessary for getting a
working Cygwin Gentoo Prefix install up and running.

Until then, this overlay will (try, at least, to) allow you to get up and running
with a Gentoo Prefix installation which works under the cygwin POSIX
compatibility library (see http://cygwin.com/ for more info).

LICENSE(S)
==========

Most of the code here was stolen from various other projects.  I have tried to
make it clear where those sources are, but, to be honest, I have probably not been
as clear as I could have been.  Where I have written my own code I'd like to
license it in as practical a manner as possible, first, and secondly, as permissive
a manner as possible.

Please treat the original portage additions such as the code in the ebuilds and
(the novel bits of) profile.bashrc as GPL-2, but please treat any other code I have
written and published here (especially, the various non-portage scripts, such as
gendiffs and portage_workdir_hacktool) as MIT/X11

By the above, however, I mean /original/ code (obviously), not stuff that is cloned
from other repositories -- and please bear in mind that I'm placing the burden of
determining which code is original on YOU -- because I have NOT clearly labelled it
all.  A lot of this is implicit, and if you are familiar with the various upstream
projects I'm borrowing from, you should have no trouble figuring out what comes
from where.  Ebuilds, of course, are copied from portage.  Patches labelled as
"cygport" are imported from the Cygwin Ports project; in all cases, purloined code
inherits the upstream license policy.

Enough about that.


Expertise Required
==================

For the time being, this code is very rough, and chock-full of bugs, not to mention
random hacks that represent failed experiments and the occasional flight of fancy
which may very well have zero or even negative value.

For this reason, to get anywhere with this overlay, you will need at least an
"intermediate" skill level with portage.  If you are a first-time Gentoo user, I
would not expect to get very far, even if, for example, you are an old-time pro
with BSD Ports but with no Gentoo experience.

This will hopefully improve, going forward, but that is the situation as of this
writing (3/3/12).


INSTALLATION (Getting started)
==============================

That being stated, to get started with gentoo-prefix under cygwin, a good place
to start is:

  http://en.gentoo-wiki.com/wiki/Prefix/Cygwin

Note that this is a different iteration on the gentoo-cygwin concept than the
one you will find at:

  http://gentoocygwin.sourceforge.net/

If I'm not mistaken, the former is referring to a (modified) vanilla Gentoo
Prefix bootstrap process, whereas the latter is a Gentoo (non-prefix) fork which
died on the vine sometime in 2008.

Cygwin has come a long way since either project has received any Cygwin-specific
love and that is why this overlay exists as a Gentoo Prefix overly, instead of as
a fork of the sourceforge project.  "Generalizing" this overlay to be compatible
with both Gentoo Prefix and regular Gentoo would, in my opinion, be a very worthy
endeavor with little downside.


BOOTSTRAPPING
=============

To bootstrap, you will, roughly, follow the recipe at:

  http://www.gentoo.org/proj/en/gentoo-alt/prefix/bootstrap-solaris.xml

But please also do skim over:

  http://en.gentoo-wiki.com/wiki/Prefix/Cygwin

Which contains the more-nearly correct instructions for initial setup of your
prefix.

A word of warning: I've been hacking on this for a while.   My initial bootstrap
efforts involved some very aggressive hacks; I have no idea, as of right now, what
would be a working, straightforward bootstrap recipe.  Going forward, I plan to
fix this somehow, either with explicit instructions or a script or both.

NOTES
=====

This overlay goes to very great pains to avoid paths beginning with '//'.
Gentoo ubiquitiously assumes that any number of preceeding slashes are a
noop in a pathname.  A number of upstream packages make the same assumption.
Unfortunately for all parties, paths beginning with '//' are not a noop.
I was surprised to learn that this is not a cygwinism -- it's a POSIXism;
according to the libtool sources, POSIX reserves the '//*' path-space for
implementation-dependent special purposes and cygwin merely makes use of
this reservation.  This means that every time Gentoo acts on this assumption,
there is a bug in Gentoo.

However, the problem is pretty nearly intractable.  The '//' assumption is so
ubiquitous as to almost be impossible to fix everywhere.  Eventually I hope to
go on a bug-hunting expedition and try to find all the places we act on this
assumption and submit Gentoo bugs for them; hopefully, others will do the same
as they spot them.  In the meanwhile, I have patched a number of utilities to
silently drop duplicate preceeding slashes from paths.  So many, in fact, it's
kinda difficult to keep track of them all.  This means that:

  CIFS PATHS BEGINNING WITH '//' ARE NOT SUPPORTED

Sorry for shouting but this is important.  If you are using my overlay, and
you are using paths like //foo/bar to get to the 'bar' share on the 'foo'
machine, things will mostly work, but please be prepared for the likelihood
that if you do any kind of development, some tool somewhere is likely to
decide that you actually mean '/foo/bar'.

This is easy to work around.  Just add your //foo/bar path to /etc/fstab
and mount it into your filesystem (i.e., as /mnt/foobar/ or w/e).  Now you
have a nice clean unambiguous way to refer to //foo/bar and all will be fine.

In the future, once we have our own ebuild for cygwin1.dll, we may wish to consider
modifying the //foo/bar feature of cygwin to work like /cygdrive, so that
for example one could use /smb/foo/bar instead of //foo/bar.  Honestly I'm not
sure why upstream doesn't do it that way themselves; it is worth investigating
if upstream cygwin would be amenable to such a change.

USING (INSTALLATION revisited)
==============================

To "install" this overlay into your cygwin-based Gentoo Prefix:

o Put this profile in a directory directly under ${EPREFIX} (below I assume you
  used "overlay")

o put this into your PORTDIR_OVERLAY variable in make.conf i.e.:

	PORTDIR_OVERLAY="${EPREFIX}/overlay"

o create ${EPREFIX}/etc/portage/repos.conf as follows:

	[DEFAULT]
	eclass-overrides = gmt_cygwin_overlay

o invoke eselect as follows:

	PORTDIR=${EPREFIX}/overlay eselect profile set 1

  but this requires a working eselect -- if you don't have that you can just

	cd ${EPREFIX}
  	rm make.profile
	ln -s ../overlay/profiles/prefix/windows/cygwin/1.7/x86/gmtoverlay \
	      make.profile


o you will need a working 'rebase' and 'peflags' in your $PATH

Once those conditions are met, with any luck (OK, with a shit-ton of luck, and
some hacking), you may or may not be able to bootstrap cygwin prefix by
following the recipe at:

  http://www.gentoo.org/proj/en/gentoo-alt/prefix/bootstrap-solaris.xml

Please don't be surprised if stuff breaks -- I haven't ever tested this -- not
even once.

If you are having trouble bootstrapping python due to a chicken-and-egg issue
with the gcc-config -> python -> gcc -> gcc-config recursive dependency, try
emerging python with the "cygbootstraphack" USE-flag.

gl!

-gmt

gmt@malth.RMIFNOTSPAMKTHX.us
