===== mutual sub-directory: "dev-lang/python" =====
---("dev-lang/python/ChangeLog")--->8--->
--- usr/portage/dev-lang/python/ChangeLog [[PORTAGE]]
+++ overlay/dev-lang/python/ChangeLog [[OVERLAY]]
@@ -1,10 +1,6 @@
 # ChangeLog for dev-lang/python
-# Copyright 1999-2012 Gentoo Foundation; Distributed under the GPL v2
-# $Header: /var/cvsroot/gentoo-x86/dev-lang/python/ChangeLog,v 1.570 2012/02/18 16:09:29 jer Exp $
-
-  01 Jan 2012; Fabian Groffen <grobian@gentoo.org> python-2.7.2-r3.ebuild:
-  Drop -u PyMac_Error from LINKFORSHARED since it assumes a framework build,
-  which we don't reference in UNIX mode
+# Copyright 1999-2011 Gentoo Foundation; Distributed under the GPL v2
+# $Header: /var/cvsroot/gentoo-x86/dev-lang/python/ChangeLog,v 1.557 2011/10/31 04:02:01 vapier Exp $
 
   01 Dec 2011; Fabian Groffen <grobian@gentoo.org> python-2.7.2.ebuild,
   python-2.7.2-r3.ebuild:
<---8<---
---("dev-lang/python/python-2.7.2-r3.ebuild")--->8--->
--- usr/portage/dev-lang/python/python-2.7.2-r3.ebuild [[PORTAGE]]
+++ overlay/dev-lang/python/python-2.7.2-r3.ebuild [[OVERLAY]]
@@ -1,6 +1,6 @@
-# Copyright 1999-2012 Gentoo Foundation
+# Copyright 1999-2011 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-x86/dev-lang/python/python-2.7.2-r3.ebuild,v 1.11 2012/02/13 18:29:32 xarthisius Exp $
+# $Header: $
 
 EAPI="2"
 WANT_AUTOMAKE="none"
@@ -34,10 +34,11 @@
 SLOT="2.7"
 PYTHON_ABI="${SLOT}"
 KEYWORDS="~ppc-aix ~x64-freebsd ~x86-freebsd ~hppa-hpux ~ia64-hpux ~x86-interix ~amd64-linux ~ia64-linux ~x86-linux ~ppc-macos ~x64-macos ~x86-macos ~m68k-mint ~sparc-solaris ~sparc64-solaris ~x64-solaris ~x86-solaris"
-IUSE="aqua -berkdb build doc elibc_uclibc examples gdbm ipv6 +ncurses +readline sqlite +ssl +threads tk +wide-unicode wininst +xml"
+IUSE="aqua -berkdb build doc elibc_uclibc examples gdbm ipv6 +ncurses +readline sqlite +ssl +threads tk +wide-unicode wininst +xml -cygbootstraphack"
 
 RDEPEND=">=app-admin/eselect-python-20091230
-		app-arch/bzip2
+		|| ( >=app-arch/bzip2-1.0.6-r3[static-libs]
+		     <app-arch/bzip2-1.0.6-r3 )
 		>=sys-libs/zlib-1.1.3
 		!m68k-mint? ( virtual/libffi )
 		virtual/libintl
@@ -96,6 +97,12 @@
 }
 
 src_prepare() {
+
+	if [[ $CHOST == *-cygwin* ]] ; then
+		epatch "${FILESDIR}"/${PN}-${PV}-cygwin.patch
+	fi
+	epatch "${FILESDIR}"/${PN}-2.7.2-cygwin-ctypes-error.patch
+
 	local excluded_patches
 
 	# Ensure that internal copies of expat, libffi and zlib are not used.
@@ -180,6 +187,49 @@
 	# Linux-3 compat. Bug #374579 (upstream issue12571)
 	cp -r "${S}/Lib/plat-linux2" "${S}/Lib/plat-linux3" || die
 
+	# hacks for bootstrap
+	if [[ ${CHOST} == *-cygwin* ]] ; then
+		if use threads ; then
+			ewarn
+			ewarn "YO!  Building with threads on cygwin is all fucked up."
+			ewarn "Don't do it, or at least read ${S}/README."
+			ewarn "Ctrl-C and disable the threads USE flag."
+			ewarn
+			ebeep
+		fi
+		if use cygbootstraphack ; then
+			cd "${S}"
+			einfo "cygbootstraphack: in $(pwd)"
+			local ldpath
+			if [[ -e ${EPREFIX}/etc/env.d/05gcc-i686-pc-cygwin1.7 ]] ; then
+				ldpath="$( cat ${EPREFIX}/etc/env.d/05gcc-i686-pc-cygwin1.7 | grep ^LDPATH | sed 's/^LDPATH="//;s/"$//' )"
+				einfo "cygbootstraphack got ldpath=\"${ldpath}\""
+			else
+				die "cygbootstraphack: FIXME: ldpath needs to be set for bootstrap compiler"
+			fi
+			local ldpaths
+			ldpaths="$(echo ${ldpath} | sed 's/:/ /g')"
+			einfo "cygbootstraphack: ldpaths=\"${ldpaths}\""
+			local ldflags=" "
+			local crtpath=""
+			for ldpathelt in ${ldpaths} ; do
+				ldflags="${ldflags} -L${ldpathelt}"
+				if [[ -e ${ldpathelt}/crtbegin.o && -e ${ldpathelt}/crtend.o ]] ; then
+					crtpath="${ldpathelt}"			
+				fi
+			done
+			ewarn "Shoving LDFLAGS+=\"${ldflags}\" down throat."
+			sed -i -e 's!^\(LDFLAGS=.*\)$!\1 '"${ldflags}"'!' Makefile.pre.in
+			ewarn "result: $(grep '^LDFLAGS=' Makefile.pre.in)"
+			if [[ -n "${crtpath}" ]] ; then
+				ewarn "stealing crtbegin.o and crtend.o from ${crtpath}"
+				cp -v "${crtpath}/crtbegin.o" "${crtpath}/crtend.o" .
+			else
+				ewarn "couldn't figure out a suitable crtpath!"
+			fi
+		fi
+	fi
+
 	eautoconf
 	eautoheader
 }
@@ -302,11 +352,17 @@
 		&& myconf="${myconf} --enable-framework=${EPREFIX}/usr/lib" \
 		|| myconf="${myconf} --enable-shared"
 
+	if [[ ${CHOST} == *-cygwin* ]] ; then
+		fpeconfig="--without-fpectl"
+	else
+		fpeconfig="--with-fpectl"
+	fi
+
 	# note: for a framework build we need to use ucs2 because OSX
 	# uses that internally too:
 	# http://bugs.python.org/issue763708
 	OPT="" econf \
-		--with-fpectl \
+		${fpeconfig} \
 		$(use_enable ipv6) \
 		$(use_with threads) \
 		$( (use wide-unicode && use !aqua) && echo "--enable-unicode=ucs4" || echo "--enable-unicode=ucs2") \
<---8<---
===== mutual sub-directory: "dev-lang/python/files" =====

*** The following files appear only in the overlay ***
overlay/dev-lang/python/files/python-2.7.2-cygwin-ctypes-error.patch: unified diff output, ASCII text
overlay/dev-lang/python/files/python-2.7.2-cygwin.patch: unified diff output, ASCII text

